name: combine-epg

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */9 * * *'  # Every 9 hours

jobs:
  merge_epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      ############################################################
      # SAFE MERGE USING XMLSTARLET (NO BROKEN XML)
      ############################################################
      - name: Merge XML files
        run: |
          set -e

          sudo apt-get update
          sudo apt-get install -y xmlstarlet

          CIGNAL="cignal_epg.xml"
          CLICK="clickthecity_epg.xml"
          DZMM="dzmm.xml"
          TV5="tv5.xml"

          echo '<?xml version="1.0" encoding="UTF-8"?>' > merged_epg.xml
          echo '<tv>' >> merged_epg.xml

          ########################################################
          # FUNCTION: Extract + rewrite channel IDs properly
          ########################################################
          rewrite_and_append() {
            FILE="$1"
            SUFFIX="$2"

            echo "Processing $FILE (.$SUFFIX)"

            # PROCESS CHANNELS
            xmlstarlet ed \
              -u "//channel/@id" -x "concat(.,'.$SUFFIX')" \
              "$FILE" | \
              xmlstarlet sel -t -c "/tv/channel" \
              >> merged_epg.xml

            # PROCESS PROGRAMMES
            xmlstarlet ed \
              -u "//programme/@channel" -x "concat(.,'.$SUFFIX')" \
              "$FILE" | \
              xmlstarlet sel -t -c "/tv/programme" \
              >> merged_epg.xml
          }

          rewrite_and_append "$CIGNAL" "cignal"
          rewrite_and_append "$CLICK"  "click"
          rewrite_and_append "$DZMM"   "dzmm"
          rewrite_and_append "$TV5"   "tv5"

          echo "</tv>" >> merged_epg.xml


      ############################################################
      # DUPLICATE REPORTING
      ############################################################
      - name: Duplicate report
        run: |
          grep -oP '(?<=<channel id=")[^"]+' merged_epg.xml | sort | uniq -d > dup_channels.txt
          grep '<programme' merged_epg.xml | \
            sed -E 's/.*channel="([^"]+)".*start="([^"]+)".*/\1|\2/' | \
            sort | uniq -d > dup_programmes.txt

          echo "Duplicate channels:"
          cat dup_channels.txt || true

          echo "Duplicate programmes:"
          cat dup_programmes.txt || true


      ############################################################
      # VALIDATE XML
      ############################################################
      - name: Validate XML
        run: |
          sudo apt-get install -y libxml2-utils
          xmllint --noout --recover merged_epg.xml
          echo "âœ” XML valid"


      ############################################################
      # GZIP OUTPUT
      ############################################################
      - name: GZIP output
        run: gzip -c merged_epg.xml > merged_epg.xml.gz


      ############################################################
      # COMMIT & PUSH
      ############################################################
      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add merged_epg.xml merged_epg.xml.gz dup_channels.txt dup_programmes.txt

          git diff --staged --quiet && echo "No changes" && exit 0

          git commit -m "Updated merged EPG with source suffix IDs"
          git pull --rebase
          git push
