name: combine-epg

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"   # Every 12 hours

jobs:
  merge_epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      ############################################################
      # MERGE XML (SAFE) + ADD SOURCE-BASED SUFFIX TO CHANNEL IDs
      ############################################################
      - name: Merge XML files into merged_epg.xml
        run: |
          set -e

          sudo apt-get update
          sudo apt-get install -y xmlstarlet

          # Locate source files
          CIGNAL=$(find . -type f -name "cignal_epg.xml" | head -n 1)
          CLICK=$(find . -type f -name "clickthecity_epg.xml" | head -n 1)
          DZMM=$(find . -type f -name "dzmm.xml" | head -n 1)

          echo "Sources:"
          echo " - CIGNAL: $CIGNAL"
          echo " - CLICK:  $CLICK"
          echo " - DZMM:   $DZMM"

          if [ -z "$CIGNAL" ] || [ -z "$CLICK" ] || [ -z "$DZMM" ]; then
            echo "ERROR: Missing XML source file!"
            exit 1
          fi

          echo '<?xml version="1.0" encoding="UTF-8"?>' > merged_epg.xml
          echo '<tv>' >> merged_epg.xml

          ############################################################
          # FUNCTION: Extract channels/programmes with modified IDs
          ############################################################
          extract_with_suffix() {
            FILE="$1"
            SUFFIX="$2"

            echo "Processing $FILE with suffix .$SUFFIX ..."

            # CHANNELS ‚Äî rewrite ID ‚Üí id="$id.$suffix"
            xmlstarlet sel -t \
              -m "/tv/channel" \
              -o '<channel id="' \
              -v "concat(@id,'.$SUFFIX')" \
              -o '">' \
              -m "display-name" -o '<display-name>' -v . -o '</display-name>' \
              -b \
              -m "icon" -o '<icon src="' -v @src -o '"/>' \
              -b \
              -o "</channel>" \
              "$FILE" >> merged_epg.xml

            # PROGRAMMES ‚Äî rewrite channel="" ‚Üí channel="$id.$suffix"
            xmlstarlet sel -t \
              -m "/tv/programme" \
              -o '<programme start="' -v @start '" stop="' -v @stop '" channel="' \
              -v "concat(@channel,'.$SUFFIX')" \
              -o '">' \
              -m "*" -c . \
              -b \
              -o "</programme>" \
              "$FILE" >> merged_epg.xml
          }

          extract_with_suffix "$CIGNAL" "cignal"
          extract_with_suffix "$CLICK" "click"
          extract_with_suffix "$DZMM" "dzmm"

          echo "</tv>" >> merged_epg.xml

          ############################################################
          # DUPLICATE REPORTING
          ############################################################
          echo ""
          echo "==============================================="
          echo "     üîç SCANNING FOR DUPLICATES (REPORT ONLY)  "
          echo "==============================================="

          # CHANNEL DUPLICATES (should be 0 now)
          grep -oP '(?<=<channel id=")[^"]+' merged_epg.xml \
            | sort | uniq -d > dup_channels.txt

          if [ -s dup_channels.txt ]; then
            echo "‚ö†Ô∏è Duplicate Channels AFTER suffixing:"
            cat dup_channels.txt
          else
            echo "‚úî No duplicate channels (suffix fix successful)."
          fi

          # PROGRAMME DUPLICATES
          grep '<programme' merged_epg.xml | \
            sed -E 's/.*channel="([^"]+)".*start="([^"]+)".*/\1|\2/' \
            | sort | uniq -d > dup_programmes.txt

          if [ -s dup_programmes.txt ]; then
            echo "‚ö†Ô∏è Duplicate programmes found:"
            cat dup_programmes.txt
          else
            echo "‚úî No duplicate programmes."
          fi

          echo "==============================================="
          echo " Merge + suffixing complete"
          echo "==============================================="


      ############################################################
      # VALIDATE XML
      ############################################################
      - name: Validate XML
        run: |
          sudo apt-get install -y libxml2-utils
          xmllint --noout merged_epg.xml
          echo "‚úî XML valid"


      ############################################################
      # GZIP OUTPUT
      ############################################################
      - name: GZIP output
        run: gzip -c merged_epg.xml > merged_epg.xml.gz


      ############################################################
      # COMMIT & PUSH
      ############################################################
      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add merged_epg.xml merged_epg.xml.gz dup_channels.txt dup_programmes.txt

          git diff --staged --quiet && echo "No changes to commit." && exit 0

          git commit -m "Update merged EPG + source-based channel ID suffixing"
          git pull --rebase
          git push
